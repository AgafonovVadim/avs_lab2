# Лабораторная работа №2 — Сетевое взаимодействие в Linux

**Цель работы.** Получить практические навыки работы с сетевой подсистемой Linux: настройка сетевых интерфейсов, NAT, SSH, прав файловой системы и удалённой работы с Jupyter.

**Требуется:** Debian Linux в VirtualBox (две виртуальные машины), доступ к настройкам VirtualBox (NAT и внутренняя сеть).

**Инструментальные средства:** 
sysctl systemctl ip useradd ss iptables iptables-save iptables-restore ls adduser passwd chmod chown who ssh-keygen scp

## Краткие теоретические сведения 

Linux сейчас является основной операционной системой для развертывания сервисов обработки данных. Доступ к Linux платформам осуществляется через сеть.

- **IP-конфигурация:** Для работы сети в общем случае нужно настроить на сетевом адаптере IP адрес, маску, адрес шлюза по умолчанию и IP адрес DNS сервера. Эти параметры можно настраивать вручную или при помощи специальной службы – DHCP.
- **DHCP:**  Dynamic Host Configuration Protocol — протокол динамической конфигурации узла — это сетевой протокол, позволяющий компьютерам автоматически получать IP-адрес и другие параметры, необходимые для работы в сети TCP/IP, запрашивая эти параметры с DHCP сервера.
- **NAT:** Network Address Translation – технология стека TCP\IP. Она позволяет модифицировать заголовки пересылаемых через NAT IP-пакетов и TCP\UDP сообщений.
- **SSH:** Secure Shell – сетевой протокол для защищенного удаленного управления компьютерами, обеспечивающий аутентификацию и шифрование канала.

> [!TIP]
> _Полезные ссылки:_ </br>
> [Основы работы с VirtualBox](https://vk.com/wall-211496571_25) </br>
> [Настройка сети в VirtualBox](https://vk.com/wall-211496571_26) </br>
> [Разбор лабораторной работы](https://t.me/c/2968776360/473) (Техническая запись)


# Порядок выполнения 

### Часть 1. Подготовка конфигурации VirtualBox и адресация

1. Для выполнения лабораторной работы вам потребуется две виртуальные машины. Создайте вторую, клонируя первую.
Две ВМ в VirtualBox:

- **gateway-vm** — шлюз, имеет два интерфейса: один — NAT VirtualBox (внешняя сеть), второй — Внутренняя сеть `intnet`.
- **client-vm** — клиент в внутренней сети `intnet`.


> [!NOTE]
> Переименовать компьютер можно, используя: </br>
> `hostnamectl set-hostname ИМЯ-ХОСТА`

3. На `gateway-vm` и `client-vm` пропишите статические адреса для внутренней сети в `interfaces` (ISU - считается, как ваш ISU % 100):
   - `gateway-vm` — `10.10.ISU.1/24`
   - `client-vm` — `10.10.ISU.2/24`

В качестве адреса DNS сервера на client-vm указать адрес 8.8.8.8 и 77.88.8.1. На client-vm в
качестве шлюза по умолчанию задайте адрес gateway-vm.

4. На `gateway-vm` оставьте внешний интерфейс в режиме DHCP (NAT VirtualBox).
5. Проверьте связность: `ping 10.10.ISU.2` с `gateway-vm`, затем `ping 8.8.8.8` с `gateway-vm`.
6. Включите форвардинг в ядре на `gateway-vm`:
   ```bash
   sudo sysctl -w net.ipv4.ip_forward=1
   # или добавить в /etc/sysctl.conf:
   # net.ipv4.ip_forward=1
   ```

### Часть 2. Пользователи и OpenSSH Server

1. На обеих виртуальных машинах создайте пользователя `FIO-LAB2-#`, где FIO - ваши инициалы, а # - тип виртуальной машины `(g или c для gateway и client соответственно)`. 
Пример для Александров Николай Иванович (`anv-lab2-g` и `anv-lab2-c`)
2. Редактируя `/etc/ssh/sshd_config`, настройте ssh сервер так, чтобы: </br>
   a. Пользователю root можно было бы входить по ssh (PermitRootLogin) </br>
   b. Максимальное количество неудачных авторизаций в сессии = 2 (MaxAuthTries) </br>
   c. Отключить определение имен хостов по DNS (UseDNS) </br>
3. Перезапустите `sshd` и сохраните вывод `systemctl status sshd` для отчёта.
4. Проверьте подключение `ssh` с `gateway-vm` на `client-vm` под созданным пользователем.

### Часть 3. Доступ к `gateway-vm` через NAT (проброс порта VirtualBox)

1. В настройках VirtualBox для `gateway-vm` на NAT-интерфейсе настройте проброс порта (Host IP и Host Port). Используйте `Host IP = 127.0.0.10`, `Host Port = 2221`, а `Guest Port = 22`.

![](https://github.com/AgafonovVadim/avs_lab2/blob/master/img/port.png)
2. С хоста (реальной машины) подключитесь к `gateway-vm` дважды: под `root` и под созданным пользователем.
3. С помощью команды `ss` определите адреса и номера портов, с которого и на который осуществлено подключение. Консольный вывод команд сохраните для отчета.
4. С помощью команды `who` определите номера виртуальных терминалов пользователей. Консольный вывод команд сохраните для отчета.

> [!IMPORTANT]
> _Бонус: Теперь команды можно вводить в терминале на вашем основном компьютере и использовать copy\paste!_
### Часть 4. NAT и iptables (на `gateway-vm`)

1. Установите `iptables` на хоста `gateway-vm`.
2. Настройте на хосте клиентский NAT (действие SNAT или MASQUERADE), так чтобы внешняя сеть стала доступна из внутренней сети.
  ``` bash
    iptables -t nat -A POSTROUTING -o ИМЯ-СЕТЕВОГО-ИНТЕРФЕЙСА-NAT -s 10.0.0.0/24 -j MASQUERADE
    # или
    iptables -t nat -A POSTROUTING -o ИМЯ-СЕТЕВОГО-ИНТЕРФЕЙСА-NAT -s 10.0.0.0/24 -j SNAT --to-source МОЙ-ВНЕШНИЙ-iP
  ```
3. Добавьте разрешения для прохождения сквозь `gateway-vm` трафика во внутреннюю сеть:
   ``` bash
   sudo iptables -A FORWARD -s 10.10.ISU.0/24 -j ACCEPT
   sudo iptables -A FORWARD -d 10.10.ISU.0/24 -j ACCEPT
   ```
   
> [!CAUTION]
> В реальности так не поступают! Это учебный пример. </br>
> В реальности ограничивают подключение по направлению и доступным портам.
   

4. Проверьте с `client-vm` доступ в Интернет.
5. Настройте публикацию порта tcp\22 на хосте `client-vm` на порту tcp\55022 на внешнем сетевом интерфейсе `gateway-vm`.
   ```bash
   iptables -t nat -A PREROUTING -i ИМЯ-СЕТЕВОГО-ИНТЕРФЕЙСА-NAT -p tcp --dport 55022 -j DNAT --to-destination 10.10.ISU.2:22
   ```
6. По подобию Части 3 настройте в VirtualBox публикацию порта 55022 на tcp порт 2222 адреса 127.0.0.10.
7. С реального хоста подключитесь по ssh к хосту `client-vm`.
8. Просмотрите правила `iptables -nvL` и `iptables -t nat -nvL` и сохраните вывод для отчёта.
8. На хосте `gateway-vm` установите пакет `iptables-persistent`. После его установки появится диалог, в котором надо дать согласие. После этого будет создан файл /etc/iptables/rules.v4 в который будут перенесены созданные вами правила.

``` bash
# Теперь при перезагрузке системы правила будут загружаться из этого файла. Без этого при перезагрузке правила «пропадут».
# Далее все вносимые изменения надо сохранять утилитой iptables-save:
iptables-save > /etc/iptables/rules.v4

# Правила из файла можно восстановить так:
iptables-restore /etc/iptables/rules.v4

# В принципе, можно редактировать файл, а потом использовать эту утилиту.
# Убедитесь, что правила сохраняются при перезагрузке ОС.
```

### Часть 5. Права на файлы и каталоги (на `client-vm`)

1. Создайте каталог `~/DATA`.
2. Создайте группу c произвольным именем.
3. Сделайте так, чтобы все члены группы могли писать, удалять любые файлы в этом каталоге, а все остальные пользователи системы могли бы только читать данные.
4. Сделайте так, чтобы созданный вами пользователь, не будучи владельцем, мог бы писать и читать данные в этот каталог.
5. Выведите все права на каталог /DATA . Консольный вывод сохраните для отчета.
6. От имени созданного вами пользователя передайте с реального хоста на сервер любой файл по ssh (утилита scp) в каталог /DATA и скачайте файл .bash_history из его домашнего каталога.

### Часть 6. Аутентификация по ключу

1. Настройте `sudo` на `client-vm`,чтобы созданный вами пользователь мог повышать привилегии с ее помощью (проверьте работу с помощью утилиты whoami).
2. На вашей реальной машине создайте пару ключей `ssh-keygen` и передайте публичный ключ на сервер.
3. Отредактируйте конфигурацию sshd так, чтобы пользователю root нельзя было подключаться по ssh, была включена аутентификация по публичным ключам, для поиска ключей использовался файл .ssh/authorized_keys. 
4. Перезапустите `sshd` и проверьте подключение `ssh` без пароля.

### Часть 7. Установка Jupyter Notebook на `client-vm` и безопасный доступ

1. Подключитесь к серверу `client-vm` под созданным пользователем.
2. Установите пакеты: `python3-pip, python3-dev, python3-venv`
3. Не все пакеты python доступны по причине того, что ставятся они через централизованный репозиторий Debian, поэтому необходимо создать виртуальное окружание.
   ```bash
   Создайте каталог ~/jupyterenv
   Создайте виртуальное окружение: python3 -m venv jupyterenv
   Активируй виртуальное окружение: source path/to/venv/bin/activate
   Установите jupyter: pip install jupyter
   Запустите jupyter-сервер: jupyter notebook
   При старте Jupyter будет выведен URL с `token` — скопируйте его.
4. Итак, Jupyter на удаленном хосте работает. Но он не доступен снаружи. Безопасно настроить доступ через ssh. Используя проброс сокетов ssh опубликуйте сокет Jupyter на сокете 127.0.0.100:8000 вашего реального хоста.
5  . Откройте в браузере `http://127.0.0.100:8000/tree?token=СКОПИРОВАННЫЙ_ТОКЕН` и создайте Notebook, проверьте `print("Hello, world")`.



## Артефакты

1. Файлы `interfaces` с обеих ВМ.
2. Вывод `systemctl status sshd` после изменения конфигурации (Часть 2).
3. Вывод `ss` и `who` (Часть 3).
4. Вывод `iptables -t nat -nvL` и `iptables -nvL` (Часть 4).
5. Команду из Части 5 п.6.
6. Команды пунктов 1 и 2 из Части 6.
7. Команду из Части 7 пункт 4.


## Вопросы для отчёта

1. Объясните понятие "Форвардинг" и какую роль он играет в вашей работе.
2. В части 4 вы использовали готовые команды для настройки NAT. Поясните какие параметры передаются в ключах команды iptables.
3. Опишите отличия MASQUERADE и SNAT формально: какие уровни абстракции они меняют, какие поля пакета переписываются и как это влияет на восстановление соединения.
4. Почему при первом SSH-подключении выводится отпечаток ключа сервера, и как это помогает безопасности?
5. Как на сервере определить количество активных SSH-подключений и список пользователей?
6. Опишите, как вы организовали права в `/DATA` и почему выбранные права решают задачу.
7. Какие плюсы и минусы у способа доступа к Jupyter через SSH-тунель по сравнению с открытием Jupyter по реальному IP и DNAT/публикацией порта? Приведите соображения по безопасности.
